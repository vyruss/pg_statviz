name: CI

on:
    push:
        branches: [ master ]
    pull_request:
        branches: [ master ]

jobs:
    lint-and-build:
        name: Lint and Build
        runs-on: ubuntu-latest
        steps:
            - name: Check out code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.13'

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install flake8 build

            - name: Lint Python code
              run: |
                  cd src/pg_statviz
                  bash flake.sh

            - name: Build Python package
              run: python -m build

            - name: Upload Python package
              uses: actions/upload-artifact@v4
              with:
                  name: python-package
                  path: dist/
                  retention-days: 1

    test-extension:
        name: Test Extension - PG${{ matrix.pg_version }}
        runs-on: ubuntu-latest
        needs: lint-and-build
        strategy:
            matrix:
                pg_version: [13, 14, 15, 16, 17, 18]
        steps:
            - name: Check out code
              uses: actions/checkout@v4

            - name: Install PostgreSQL ${{ matrix.pg_version }}
              run: |
                  wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
                  echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
                  sudo apt-get update
                  sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}

            - name: Build and install extension
              run: |
                  sudo make install PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config

            - name: Initialize PostgreSQL
              run: |
                  sudo -u postgres /usr/lib/postgresql/${{ matrix.pg_version }}/bin/initdb -D /tmp/pgdata
                  sudo -u postgres /usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_ctl -D /tmp/pgdata -l /tmp/postgres.log start

            - name: Wait for PostgreSQL
              run: |
                  for i in {1..30}; do
                      if sudo -u postgres /usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_isready -q; then
                          echo "PostgreSQL is ready"
                          break
                      fi
                      echo "Waiting for PostgreSQL... ($i/30)"
                      sleep 1
                  done

            - name: Run extension tests
              run: |
                  sudo make installcheck PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config

            - name: Show regression diffs on failure
              if: failure()
              run: |
                  if [ -f regression.diffs ]; then
                      cat regression.diffs
                  fi

            - name: Shutdown PostgreSQL
              if: always()
              run: |
                  sudo -u postgres /usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_ctl -D /tmp/pgdata stop || true

    test-python:
        name: Test Python Utility
        runs-on: ubuntu-latest
        needs: lint-and-build
        steps:
            - name: Check out code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.13'

            - name: Install PostgreSQL 18
              run: |
                  wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg
                  echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
                  sudo apt-get update
                  sudo apt-get install -y postgresql-18

            - name: Install extension
              run: |
                  sudo make install PG_CONFIG=/usr/lib/postgresql/18/bin/pg_config

            - name: Initialize PostgreSQL
              run: |
                  sudo -u postgres /usr/lib/postgresql/18/bin/initdb -D /tmp/pgdata
                  cat >> /tmp/pgdata/postgresql.conf << 'EOF'
                  wal_level = logical
                  max_replication_slots = 4
                  max_wal_senders = 4
                  EOF
                  sudo -u postgres /usr/lib/postgresql/18/bin/pg_ctl -D /tmp/pgdata -l /tmp/postgres.log start

            - name: Wait for PostgreSQL
              run: |
                  for i in {1..30}; do
                      if sudo -u postgres /usr/lib/postgresql/18/bin/pg_isready -q; then
                          echo "PostgreSQL is ready"
                          break
                      fi
                      echo "Waiting for PostgreSQL... ($i/30)"
                      sleep 1
                  done

            - name: Create test database
              run: |
                  sudo -u postgres psql -c "CREATE DATABASE testdb;"
                  sudo -u postgres psql -d testdb -c "CREATE EXTENSION pg_statviz;"

            - name: Setup logical replication
              run: |
                  sudo -u postgres psql -c "CREATE DATABASE dummydb;"
                  sudo -u postgres psql -d testdb -c 'CREATE PUBLICATION dummy_pub FOR TABLES IN SCHEMA pgstatviz;'
                  sudo -u postgres psql -d dummydb -c "CREATE EXTENSION pg_statviz;"
                  sudo -u postgres psql -d testdb -c "SELECT pg_create_logical_replication_slot('dummy_sub', 'pgoutput');"
                  sudo -u postgres psql -d dummydb -c "CREATE SUBSCRIPTION dummy_sub CONNECTION 'dbname=testdb host=localhost' PUBLICATION dummy_pub WITH (copy_data = false, origin = none, create_slot = false);"

            - name: Take snapshots
              run: |
                  for i in {1..5}; do
                      sudo -u postgres psql -d testdb -c "SELECT pgstatviz.snapshot();"
                      sleep 2
                  done

            - name: Install Python package
              run: |
                  pip install .

            - name: Test pg_statviz utility
              run: |
                  mkdir -p /tmp/output
                  pg_statviz --help
                  pg_statviz --version
                  sudo -u postgres pg_statviz -d testdb -O /tmp/output

            - name: Verify output files
              run: |
                  ls -lh /tmp/output/
                  if [ $(ls /tmp/output/*.png 2>/dev/null | wc -l) -lt 1 ]; then
                      echo "ERROR: No visualization files generated"
                      exit 1
                  fi
                  echo "âœ“ Visualization files generated"

            - name: Shutdown PostgreSQL
              if: always()
              run: |
                  sudo -u postgres /usr/lib/postgresql/18/bin/pg_ctl -D /tmp/pgdata stop || true
